<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ•…äº‹é“º</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- è¿”å›å·¥å…·ç®±æŒ‰é’® -->
    <button class="back-button" onclick="goBackToTools()">è¿”å›å·¥å…·ç®±</button>
    <!-- æ±‰å ¡èœå•æŒ‰é’® -->
    <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    
    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1>å°æ•…äº‹é“º</h1>
            </div>
            <nav class="menu">
                <div class="menu-group">
                    <h2 class="menu-title">åŸºç¡€åŠŸèƒ½</h2>
                    <ul>
                        <li><a href="#" onclick="showAllStories()"> <span class="icon">ğŸ“š</span> å…¨éƒ¨æ•…äº‹ </a></li>
                        <li><a href="#" onclick="toggleSearch()"> <span class="icon">ğŸ”</span> æ•…äº‹æœç´¢ </a></li>
                    </ul>
                </div>
                <div class="menu-group">
                    <h2 class="menu-title">æ•…äº‹åˆ†ç±»</h2>
                    <ul id="categoryMenu">
                        <!-- åˆ†ç±»èœå•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </div>
            </nav>
        </aside>
        <main class="content">
            <div class="search-container" id="searchContainer" style="display: none;">
                <input type="text" id="searchInput" placeholder="æœç´¢æ•…äº‹æ ‡é¢˜..." onkeyup="searchStories()">
            </div>
            <div class="current-category">
                <h2 id="currentCategoryTitle">å…¨éƒ¨æ•…äº‹</h2>
                <span id="storyCount">åŠ è½½ä¸­...</span>
            </div>
            <div class="story-grid" id="storyGrid">
                <!-- æ•…äº‹å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </main>
    </div>

    <!-- æ•…äº‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="storyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="story-meta">
                    <span id="modalCategory"></span>
                    <span id="modalLength"></span>
                </div>
                <div class="story-content" id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let categories = [];
        let stories = [];
        let allStoryContents = new Map(); // æ”¹ä¸ºMapå­˜å‚¨ï¼ŒæŒ‰éœ€åŠ è½½
        let loadedBatches = new Set(); // è®°å½•å·²åŠ è½½çš„æ‰¹æ¬¡
        let currentCategory = null;
        let filteredStories = [];
        let currentPage = 1;
        const storiesPerPage = 20; // æ¯é¡µæ˜¾ç¤º20ä¸ªæ•…äº‹
        let isLoading = false;

        // åˆ†ç±»å›¾æ ‡æ˜ å°„
        const categoryIcons = {
            'ç¡å‰æ•…äº‹': 'ğŸŒ™',
            'å„¿ç«¥æ•…äº‹': 'ğŸ§’',
            'æ ¼æ—ç«¥è¯': 'ğŸŒ³',
            'æ°‘é—´æ•…äº‹': 'ğŸ“œ',
            'ç›Šæ™ºæ•…äº‹': 'ğŸ§©',
            'å†å²æ•…äº‹': 'ğŸ›ï¸',
            'å¯“è¨€æ•…äº‹': 'ğŸ¦Š',
            'ç»å…¸ç«¥è¯': 'ğŸ‘‘',
            'æˆè¯­æ•…äº‹': 'ğŸ“–',
            'ç«¥è¯ä½œæ–‡': 'âœï¸',
            'èŠæ–‹å¿—å¼‚': 'ğŸ‘»'
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // åŠ è½½åŸºç¡€æ•°æ®ï¼ˆä¸åŒ…å«æ•…äº‹å†…å®¹ï¼‰
        async function loadData() {
            try {
                // ä½¿ç”¨ä¼˜åŒ–åçš„JSONæ–‡ä»¶
                const [categoriesResponse, storiesResponse] = await Promise.all([
                    fetch('supabase_categories.json'),
                    fetch('stories_optimized.json')
                ]);

                categories = await categoriesResponse.json();
                stories = await storiesResponse.json();

                // æŒ‰sort_idæ’åºåˆ†ç±»
                categories.sort((a, b) => b.sort_id - a.sort_id);

                // åˆå§‹åŒ–ç•Œé¢
                generateCategoryMenu();
                showAllStories();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                // å¦‚æœä¼˜åŒ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŸå§‹æ–‡ä»¶
                try {
                    const [categoriesResponse, storiesResponse] = await Promise.all([
                        fetch('supabase_categories.json'),
                        fetch('supabase_stories.json')
                    ]);

                    categories = await categoriesResponse.json();
                    stories = await storiesResponse.json();

                    // æŒ‰sort_idæ’åºåˆ†ç±»
                    categories.sort((a, b) => b.sort_id - a.sort_id);

                    // åˆå§‹åŒ–ç•Œé¢
                    generateCategoryMenu();
                    showAllStories();
                } catch (fallbackError) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', fallbackError);
                    document.getElementById('storyGrid').innerHTML = '<p>åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>';
                }
            }
        }

        // æ‡’åŠ è½½æ•…äº‹å†…å®¹
        async function loadStoryContent(storyId) {
            if (allStoryContents.has(storyId)) {
                return allStoryContents.get(storyId);
            }

            try {
                // è®¡ç®—æ•…äº‹IDæ‰€åœ¨çš„æ‰¹æ¬¡
                const batchSize = 100;
                const batchNumber = Math.ceil(storyId / batchSize);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªæ‰¹æ¬¡
                const batchKey = `batch_${batchNumber}`;
                if (!loadedBatches.has(batchKey)) {
                    const response = await fetch(`contents/batch_${batchNumber}.json`);
                    if (response.ok) {
                        const contents = await response.json();
                        
                        contents.forEach(content => {
                            allStoryContents.set(content.story_id, content);
                        });
                        
                        loadedBatches.add(batchKey);
                    } else {
                        // å¦‚æœæ‰¹æ¬¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå›é€€åˆ°åŠ è½½æ‰€æœ‰å†…å®¹
                        const fallbackResponse = await fetch('supabase_story_contents.json');
                        const allContents = await fallbackResponse.json();
                        
                        allContents.forEach(content => {
                            allStoryContents.set(content.story_id, content);
                        });
                    }
                }

                return allStoryContents.get(storyId);
            } catch (error) {
                console.error('åŠ è½½æ•…äº‹å†…å®¹å¤±è´¥:', error);
                return null;
            }
        }

        // ç”Ÿæˆåˆ†ç±»èœå•
        function generateCategoryMenu() {
            const menuContainer = document.getElementById('categoryMenu');
            menuContainer.innerHTML = '';

            categories.forEach(category => {
                const li = document.createElement('li');
                const icon = categoryIcons[category.name] || 'ğŸ“š';
                li.innerHTML = `
                    <a href="#" onclick="filterByCategory(${category.id}, '${category.name}')">
                        <span class="icon">${icon}</span> ${category.name}
                    </a>
                `;
                menuContainer.appendChild(li);
            });
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ•…äº‹
        function showAllStories() {
            currentCategory = null;
            filteredStories = stories;
            updateActiveMenu('all');
            document.getElementById('currentCategoryTitle').textContent = 'å…¨éƒ¨æ•…äº‹';
            renderStories();
        }

        // æŒ‰åˆ†ç±»ç­›é€‰æ•…äº‹
        function filterByCategory(categoryId, categoryName) {
            currentCategory = categoryId;
            filteredStories = stories.filter(story => story.category_id === categoryId);
            updateActiveMenu(categoryId);
            document.getElementById('currentCategoryTitle').textContent = categoryName;
            renderStories();
        }

        // æ›´æ–°æ´»è·ƒèœå•é¡¹
        function updateActiveMenu(activeId) {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
            
            // æ·»åŠ æ´»è·ƒçŠ¶æ€
            if (activeId === 'all') {
                document.querySelector('.menu a[onclick="showAllStories()"]').parentElement.classList.add('active');
            } else {
                document.querySelector(`.menu a[onclick="filterByCategory(${activeId}, '${categories.find(c => c.id === activeId)?.name}')"]`)?.parentElement.classList.add('active');
            }
        }

        // æ¸²æŸ“æ•…äº‹å¡ç‰‡ï¼ˆåˆ†é¡µï¼‰
        function renderStories(append = false) {
            const grid = document.getElementById('storyGrid');
            const storyCount = document.getElementById('storyCount');
            
            storyCount.textContent = `å…± ${filteredStories.length} ä¸ªæ•…äº‹`;

            if (filteredStories.length === 0) {
                grid.innerHTML = '<p class="no-stories">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ•…äº‹</p>';
                return;
            }

            const startIndex = (currentPage - 1) * storiesPerPage;
            const endIndex = startIndex + storiesPerPage;
            const currentPageStories = filteredStories.slice(startIndex, endIndex);

            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–DOMæ“ä½œ
            const fragment = document.createDocumentFragment();
            
            currentPageStories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                storyCard.onclick = () => openStoryModal(story.id);
                
                storyCard.innerHTML = `
                    <h3>${story.title}</h3>
                    <p>${story.excerpt}</p>
                    <div class="card-footer">
                        <span>${story.category_name}</span>
                        <span>${story.length}å­—</span>
                    </div>
                `;
                
                fragment.appendChild(storyCard);
            });

            // æ·»åŠ åŠ è½½æ›´å¤šæŒ‰é’®
            if (endIndex < filteredStories.length) {
                const loadMoreContainer = document.createElement('div');
                loadMoreContainer.className = 'load-more-container';
                
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.className = 'load-more-btn';
                loadMoreBtn.textContent = `åŠ è½½æ›´å¤š (${filteredStories.length - endIndex} ä¸ªæ•…äº‹)`;
                loadMoreBtn.disabled = isLoading;
                loadMoreBtn.onclick = loadMoreStories;
                
                loadMoreContainer.appendChild(loadMoreBtn);
                fragment.appendChild(loadMoreContainer);
            }

            if (append) {
                // ç§»é™¤æ—§çš„åŠ è½½æ›´å¤šæŒ‰é’®
                const oldLoadMore = grid.querySelector('.load-more-container');
                if (oldLoadMore) {
                    oldLoadMore.remove();
                }
                grid.appendChild(fragment);
            } else {
                // ä¸€æ¬¡æ€§æ›´æ–°DOM
                grid.innerHTML = '';
                grid.appendChild(fragment);
            }
        }

        // åŠ è½½æ›´å¤šæ•…äº‹
        function loadMoreStories() {
            if (isLoading) return;
            
            isLoading = true;
            const loadMoreBtn = document.querySelector('.load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
                loadMoreBtn.disabled = true;
            }

            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            setTimeout(() => {
                currentPage++;
                renderStories(true);
                isLoading = false;
                
                // é‡æ–°å¯ç”¨æŒ‰é’®å¹¶æ›´æ–°æ–‡æœ¬
                const newLoadMoreBtn = document.querySelector('.load-more-btn');
                if (newLoadMoreBtn) {
                    newLoadMoreBtn.disabled = false;
                    const remainingStories = filteredStories.length - (currentPage * storiesPerPage);
                    if (remainingStories > 0) {
                        newLoadMoreBtn.textContent = `åŠ è½½æ›´å¤š (${remainingStories} ä¸ªæ•…äº‹)`;
                    }
                }
            }, 300);
        }

        // æ‰“å¼€æ•…äº‹è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆæ‡’åŠ è½½å†…å®¹ï¼‰
        async function openStoryModal(storyId) {
            const story = stories.find(s => s.id === storyId);
            
            if (!story) return;

            document.getElementById('modalTitle').textContent = story.title;
            document.getElementById('modalCategory').textContent = story.category_name;
            document.getElementById('modalLength').textContent = `${story.length}å­—`;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('modalContent').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•…äº‹å†…å®¹...</div>';
            document.getElementById('storyModal').style.display = 'block';
            document.body.style.overflow = 'hidden';

            // å¼‚æ­¥åŠ è½½æ•…äº‹å†…å®¹
            try {
                const contentObj = await loadStoryContent(storyId);
                if (contentObj && contentObj.content) {
                    document.getElementById('modalContent').innerHTML = contentObj.content.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('modalContent').innerHTML = '<p>å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
                }
            } catch (error) {
                document.getElementById('modalContent').innerHTML = '<p>å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('storyModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // åˆ‡æ¢æœç´¢æ¡†æ˜¾ç¤º
        function toggleSearch() {
            const searchContainer = document.getElementById('searchContainer');
            const searchInput = document.getElementById('searchInput');
            
            if (searchContainer.style.display === 'none') {
                searchContainer.style.display = 'block';
                searchInput.focus();
            } else {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                // å¦‚æœå½“å‰æœ‰åˆ†ç±»ç­›é€‰ï¼Œæ¢å¤åˆ†ç±»ç­›é€‰ï¼Œå¦åˆ™æ˜¾ç¤ºå…¨éƒ¨
                if (currentCategory) {
                    const category = categories.find(c => c.id === currentCategory);
                    filterByCategory(currentCategory, category.name);
                } else {
                    showAllStories();
                }
            }
        }

        // è·å–è¿‡æ»¤åçš„æ•…äº‹
        function getFilteredStories() {
            let filtered = stories;
            
            // æŒ‰åˆ†ç±»è¿‡æ»¤
            if (currentCategory !== null) {
                filtered = filtered.filter(story => story.category_id === currentCategory);
            }
            
            // æŒ‰æœç´¢è¯è¿‡æ»¤
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                filtered = filtered.filter(story => 
                    story.title.toLowerCase().includes(searchTerm) || 
                    story.excerpt.toLowerCase().includes(searchTerm)
                );
            }
            
            return filtered;
        }

        // æœç´¢æ•…äº‹
        function searchStories() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¢å¤å½“å‰åˆ†ç±»çš„æ•…äº‹
                if (currentCategory) {
                    const category = categories.find(c => c.id === currentCategory);
                    filterByCategory(currentCategory, category.name);
                } else {
                    showAllStories();
                }
                return;
            }

            // åœ¨å½“å‰åˆ†ç±»ä¸­æœç´¢
            const baseStories = currentCategory ? 
                stories.filter(story => story.category_id === currentCategory) : 
                stories;
            
            filteredStories = baseStories.filter(story => 
                story.title.toLowerCase().includes(searchTerm) ||
                story.excerpt.toLowerCase().includes(searchTerm)
            );

            currentPage = 1; // é‡ç½®åˆ†é¡µ
            document.getElementById('currentCategoryTitle').textContent = 
                `æœç´¢ç»“æœ: "${searchTerm}"`;
            renderStories();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('storyModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶å‡½æ•°
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // è¿”å›å·¥å…·ç®±ï¼ˆè·³è½¬åˆ°ä¸Šçº§ç›®å½•é¦–é¡µï¼‰
        function goBackToTools() {
            // ä½¿ç”¨ç›¸å¯¹è·¯å¾„è¿”å›åˆ°å·¥å…·ç®±é¦–é¡µ
            window.location.href = '../index.html';
        }

        // ç‚¹å‡»ä¾§è¾¹æ å†…çš„é“¾æ¥åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarLinks = document.querySelectorAll('.sidebar a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeSidebar();
                    }
                });
            });
        });
    </script>
</body>
</html>
